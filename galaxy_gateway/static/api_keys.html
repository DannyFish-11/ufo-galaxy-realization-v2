<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy - API Key ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        .gradient-bg {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #0f0f23 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .key-card {
            transition: all 0.3s;
        }
        .key-card:hover {
            transform: translateY(-2px);
        }
        .category-llm { border-left: 3px solid #00d4ff; }
        .category-tool { border-left: 3px solid #00ff88; }
        .category-storage { border-left: 3px solid #ffaa00; }
        .category-media { border-left: 3px solid #ff55aa; }
    </style>
</head>
<body class="gradient-bg min-h-screen text-white">
    <div id="app" v-cloak>
        <!-- Header -->
        <header class="border-b border-white/10">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="text-3xl">ğŸ”‘</div>
                        <div>
                            <h1 class="text-2xl font-bold bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent">
                                API Key ç®¡ç†
                            </h1>
                            <p class="text-sm text-gray-400">ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ API Key</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-gray-400 hover:text-white transition">æ§åˆ¶é¢æ¿</a>
                        <a href="/config" class="text-gray-400 hover:text-white transition">é…ç½®</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-8">
            <!-- ç»Ÿè®¡ -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-card rounded-xl p-6">
                    <div class="text-gray-400 text-sm mb-2">æ€»é…ç½®æ•°</div>
                    <div class="text-3xl font-bold text-cyan-400">{{ status.total || 0 }}</div>
                </div>
                <div class="glass-card rounded-xl p-6">
                    <div class="text-gray-400 text-sm mb-2">å·²é…ç½®</div>
                    <div class="text-3xl font-bold text-green-400">{{ status.configured || 0 }}</div>
                </div>
                <div class="glass-card rounded-xl p-6">
                    <div class="text-gray-400 text-sm mb-2">å·²å¯ç”¨</div>
                    <div class="text-3xl font-bold text-purple-400">{{ status.enabled || 0 }}</div>
                </div>
                <div class="glass-card rounded-xl p-6">
                    <div class="text-gray-400 text-sm mb-2">æ¨èé…ç½®</div>
                    <div class="text-xl font-bold text-yellow-400">OneAPI</div>
                </div>
            </div>

            <!-- OneAPI æ¨èå¡ç‰‡ -->
            <div class="glass-card rounded-xl p-6 mb-8 border-2 border-cyan-500/30">
                <div class="flex items-start justify-between">
                    <div>
                        <div class="flex items-center space-x-3 mb-3">
                            <span class="text-2xl">â­</span>
                            <h2 class="text-xl font-bold text-cyan-400">æ¨èï¼šä½¿ç”¨ OneAPI ç»Ÿä¸€ç½‘å…³</h2>
                        </div>
                        <p class="text-gray-300 mb-4">
                            é…ç½® OneAPI åï¼Œæ‰€æœ‰ LLM è¯·æ±‚é€šè¿‡ç»Ÿä¸€ç½‘å…³ï¼Œæ— éœ€å•ç‹¬é…ç½®å„ LLM API Keyã€‚<br>
                            æ”¯æŒ OpenAIã€DeepSeekã€Claudeã€Gemini ç­‰æ‰€æœ‰ä¸»æµæ¨¡å‹ã€‚
                        </p>
                        <div class="flex items-center space-x-4">
                            <button @click="showEditModal('oneapi')" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg">
                                é…ç½® OneAPI
                            </button>
                            <a href="https://github.com/songquanpeng/one-api" target="_blank" class="text-cyan-400 hover:text-cyan-300">
                                äº†è§£ OneAPI â†’
                            </a>
                        </div>
                    </div>
                    <div v-if="oneapiConfigured" class="text-green-400 text-sm">
                        âœ… å·²é…ç½®
                    </div>
                </div>
            </div>

            <!-- åˆ†ç±»æ ‡ç­¾ -->
            <div class="flex space-x-4 mb-6">
                <button @click="activeCategory = null" 
                        :class="['px-4 py-2 rounded-lg transition', activeCategory === null ? 'bg-cyan-600' : 'bg-white/5 hover:bg-white/10']">
                    å…¨éƒ¨
                </button>
                <button @click="activeCategory = 'llm'" 
                        :class="['px-4 py-2 rounded-lg transition', activeCategory === 'llm' ? 'bg-cyan-600' : 'bg-white/5 hover:bg-white/10']">
                    ğŸ¤– LLM æ¨¡å‹
                </button>
                <button @click="activeCategory = 'tool'" 
                        :class="['px-4 py-2 rounded-lg transition', activeCategory === 'tool' ? 'bg-cyan-600' : 'bg-white/5 hover:bg-white/10']">
                    ğŸ”§ å·¥å…·æœåŠ¡
                </button>
                <button @click="activeCategory = 'storage'" 
                        :class="['px-4 py-2 rounded-lg transition', activeCategory === 'storage' ? 'bg-cyan-600' : 'bg-white/5 hover:bg-white/10']">
                    ğŸ’¾ å­˜å‚¨æœåŠ¡
                </button>
                <button @click="activeCategory = 'media'" 
                        :class="['px-4 py-2 rounded-lg transition', activeCategory === 'media' ? 'bg-cyan-600' : 'bg-white/5 hover:bg-white/10']">
                    ğŸ¬ åª’ä½“ç”Ÿæˆ
                </button>
            </div>

            <!-- API Key åˆ—è¡¨ -->
            <div class="glass-card rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold">API Key åˆ—è¡¨</h2>
                    <button @click="exportEnv" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-sm">
                        å¯¼å‡ºç¯å¢ƒå˜é‡
                    </button>
                </div>
                
                <div v-if="filteredKeys.length === 0" class="text-center py-12 text-gray-400">
                    <div class="text-4xl mb-4">ğŸ”‘</div>
                    <div>æš‚æ—  API Key é…ç½®</div>
                </div>
                
                <div v-else class="space-y-3">
                    <div v-for="key in filteredKeys" :key="key.key_type" 
                         class="key-card p-4 rounded-lg bg-white/5"
                         :class="'category-' + key.category">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3">
                                    <span class="font-medium">{{ key.name }}</span>
                                    <span v-if="key.required" class="text-xs px-2 py-0.5 rounded bg-red-500/20 text-red-400">
                                        å¿…éœ€
                                    </span>
                                    <span v-if="key.has_key" class="text-xs px-2 py-0.5 rounded bg-green-500/20 text-green-400">
                                        å·²é…ç½®
                                    </span>
                                    <span v-else class="text-xs px-2 py-0.5 rounded bg-gray-500/20 text-gray-400">
                                        æœªé…ç½®
                                    </span>
                                </div>
                                <div class="text-sm text-gray-400 mt-1">{{ key.description }}</div>
                                <div v-if="key.has_key" class="text-xs text-gray-500 mt-1">
                                    Key: {{ key.key }}
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button @click="showEditModal(key.key_type)" 
                                        class="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-700 rounded text-sm">
                                    {{ key.has_key ? 'ä¿®æ”¹' : 'é…ç½®' }}
                                </button>
                                <button v-if="key.has_key" @click="toggleEnable(key)" 
                                        :class="['px-3 py-1.5 rounded text-sm', key.enabled ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-green-600 hover:bg-green-700']">
                                    {{ key.enabled ? 'ç¦ç”¨' : 'å¯ç”¨' }}
                                </button>
                                <button v-if="key.has_key" @click="deleteKey(key)" 
                                        class="px-3 py-1.5 bg-red-600 hover:bg-red-700 rounded text-sm">
                                    åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ç¼–è¾‘å¼¹çª— -->
        <div v-if="showModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass-card rounded-xl p-6 w-full max-w-md">
                <h3 class="text-xl font-semibold mb-4">{{ editingKey?.name || 'é…ç½® API Key' }}</h3>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">API Key</label>
                        <input v-model="editForm.key" type="password" 
                               class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-cyan-500"
                               placeholder="è¾“å…¥ API Key">
                    </div>
                    
                    <div v-if="editingKey?.key_type !== 'oneapi' || !editingKey?.url">
                        <label class="block text-sm text-gray-400 mb-2">API URL (å¯é€‰)</label>
                        <input v-model="editForm.url" type="text" 
                               class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-500 outline-none focus:border-cyan-500"
                               placeholder="è¾“å…¥ API URL">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button @click="showModal = false" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg">
                        å–æ¶ˆ
                    </button>
                    <button @click="saveKey" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-700 rounded-lg">
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast -->
        <div v-if="toast.show" 
             :class="['fixed bottom-8 right-8 px-6 py-3 rounded-lg shadow-lg', 
                      toast.type === 'success' ? 'bg-green-600' : 'bg-red-600']">
            {{ toast.message }}
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    status: {},
                    keys: [],
                    activeCategory: null,
                    showModal: false,
                    editingKey: null,
                    editForm: { key: '', url: '' },
                    toast: { show: false, message: '', type: 'success' }
                };
            },
            computed: {
                filteredKeys() {
                    if (!this.activeCategory) return this.keys;
                    return this.keys.filter(k => k.category === this.activeCategory);
                },
                oneapiConfigured() {
                    const oneapi = this.keys.find(k => k.key_type === 'oneapi');
                    return oneapi && oneapi.has_key;
                }
            },
            mounted() {
                this.loadStatus();
                this.loadKeys();
            },
            methods: {
                async loadStatus() {
                    try {
                        const resp = await axios.get('/api/keys/status');
                        this.status = resp.data;
                    } catch (e) {}
                },
                
                async loadKeys() {
                    try {
                        const resp = await axios.get('/api/keys/list');
                        this.keys = resp.data;
                    } catch (e) {}
                },
                
                showEditModal(keyType) {
                    const key = this.keys.find(k => k.key_type === keyType);
                    this.editingKey = key;
                    this.editForm = { key: '', url: key?.url || '' };
                    this.showModal = true;
                },
                
                async saveKey() {
                    if (!this.editForm.key) {
                        this.showToast('è¯·è¾“å…¥ API Key', 'error');
                        return;
                    }
                    
                    try {
                        await axios.post(`/api/keys/${this.editingKey.key_type}`, this.editForm);
                        this.showToast('ä¿å­˜æˆåŠŸ', 'success');
                        this.showModal = false;
                        this.loadKeys();
                        this.loadStatus();
                    } catch (e) {
                        this.showToast('ä¿å­˜å¤±è´¥: ' + (e.response?.data?.detail || e.message), 'error');
                    }
                },
                
                async toggleEnable(key) {
                    try {
                        await axios.post(`/api/keys/${key.key_type}/enable`, { enabled: !key.enabled });
                        this.showToast(key.enabled ? 'å·²ç¦ç”¨' : 'å·²å¯ç”¨', 'success');
                        this.loadKeys();
                    } catch (e) {
                        this.showToast('æ“ä½œå¤±è´¥', 'error');
                    }
                },
                
                async deleteKey(key) {
                    if (!confirm('ç¡®å®šåˆ é™¤æ­¤ API Keyï¼Ÿ')) return;
                    
                    try {
                        await axios.delete(`/api/keys/${key.key_type}`);
                        this.showToast('å·²åˆ é™¤', 'success');
                        this.loadKeys();
                        this.loadStatus();
                    } catch (e) {
                        this.showToast('åˆ é™¤å¤±è´¥', 'error');
                    }
                },
                
                async exportEnv() {
                    try {
                        const resp = await axios.get('/api/keys/export/env');
                        const env = resp.data;
                        const text = Object.entries(env).map(([k, v]) => `${k}=${v}`).join('\n');
                        
                        // å¤åˆ¶åˆ°å‰ªè´´æ¿
                        navigator.clipboard.writeText(text);
                        this.showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    } catch (e) {
                        this.showToast('å¯¼å‡ºå¤±è´¥', 'error');
                    }
                },
                
                showToast(message, type) {
                    this.toast = { show: true, message, type };
                    setTimeout(() => { this.toast.show = false; }, 3000);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
