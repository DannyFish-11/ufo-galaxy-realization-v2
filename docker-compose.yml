# UFO Galaxy - Docker/Podman 部署配置
# 使用方式:
#   Docker: docker-compose up -d
#   Podman: podman-compose up -d
#
# 新增服务:
#   - Neo4j: 图数据库 (MemOS 记忆系统)
#   - Qdrant: 向量数据库 (语义搜索)
#   - Coturn: WebRTC TURN 服务器
#   - MinIO: 对象存储
#   - Redis: 缓存和消息队列
#   - MongoDB: 文档存储

version: '3.8'

services:
  # ============ UFO Galaxy 统一网关 ============
  ufo-gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    container_name: ufo-galaxy-gateway
    ports:
      - "8000:8000"
    environment:
      # OneAPI 配置 (推荐)
      - ONEAPI_URL=${ONEAPI_URL:-}
      - ONEAPI_API_KEY=${ONEAPI_API_KEY:-}

      # 直连 API Keys (备用)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      - XAI_API_KEY=${XAI_API_KEY:-}

      # 本地模型
      - OLLAMA_URL=${OLLAMA_URL:-http://ollama:11434}
      - VLLM_URL=${VLLM_URL:-}

      # Neo4j 配置
      - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-neo4j123}

      # Qdrant 配置
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}

      # WebRTC 配置
      - STUN_SERVERS=${STUN_SERVERS:-stun:stun.l.google.com:19302,stun:stun1.l.google.com:19302}
      - TURN_SERVER=${TURN_SERVER:-}
      - TURN_USERNAME=${TURN_USERNAME:-}
      - TURN_CREDENTIAL=${TURN_CREDENTIAL:-}

      # MinIO 配置
      - MINIO_ENDPOINT=${MINIO_ENDPOINT:-minio:9000}
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin123}
      - MINIO_BUCKET=${MINIO_BUCKET:-ufo-galaxy}

      # MongoDB 配置
      - MONGODB_URI=${MONGODB_URI:-mongodb://mongodb:27017}
      - MONGODB_DB=${MONGODB_DB:-ufo-galaxy}

    depends_on:
      ollama:
        condition: service_started
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
      mongodb:
        condition: service_healthy
    networks:
      - ufo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ Neo4j 图数据库 (MemOS 记忆系统) ============
  neo4j:
    image: neo4j:5.15-community
    container_name: neo4j
    ports:
      - "7474:7474"  # HTTP Browser
      - "7687:7687"  # Bolt Protocol
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-neo4j123}
      - NEO4J_PLUGINS=["apoc", "gds"]  # APOC 和 Graph Data Science 插件
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-import:/var/lib/neo4j/import
      - neo4j-plugins:/plugins
    networks:
      - ufo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============ Qdrant 向量数据库 ============
  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: qdrant
    ports:
      - "6333:6333"       # REST API
      - "6334:6334"       # gRPC
    environment:
      - QDRANT__SERVICE__API_KEY=${QDRANT_API_KEY:-}
      - QDRANT__SERVICE__ENABLE_CORS=true
      - QDRANT__STORAGE__STORAGE_PATH=/qdrant/storage
      - QDRANT__STORAGE__SNAPSHOTS_PATH=/qdrant/snapshots
      - QDRANT__TELEMETRY_DISABLED=true
    volumes:
      - qdrant-storage:/qdrant/storage
      - qdrant-snapshots:/qdrant/snapshots
    networks:
      - ufo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============ Coturn TURN 服务器 (WebRTC) ============
  coturn:
    image: coturn/coturn:4.6.2
    container_name: coturn
    ports:
      - "3478:3478"       # STUN/TURN
      - "3478:3478/udp"
      - "5349:5349"       # STUN/TURN TLS
      - "5349:5349/udp"
      - "49152-65535:49152-65535/udp"  # Relay ports
    environment:
      - TURN_REALM=${TURN_REALM:-ufo-galaxy.local}
      - TURN_USER=${TURN_USERNAME:-ufo}
      - TURN_PASSWORD=${TURN_CREDENTIAL:-ufo123}
      - TURN_MIN_PORT=49152
      - TURN_MAX_PORT=65535
    command: >
      -n -v
      --realm=${TURN_REALM:-ufo-galaxy.local}
      --fingerprint
      --lt-cred-mech
      --user=${TURN_USERNAME:-ufo}:${TURN_CREDENTIAL:-ufo123}
      --external-ip=${EXTERNAL_IP:-$(detect-external-ip)}
      --listening-port=3478
      --tls-listening-port=5349
      --min-port=49152
      --max-port=65535
      --log-file=stdout
      --no-cli
    networks:
      - ufo-network
    restart: unless-stopped
    profiles:
      - full
      - webrtc

  # ============ MinIO 对象存储 ============
  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: minio
    ports:
      - "9000:9000"       # API
      - "9001:9001"       # Console
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin123}
      - MINIO_BROWSER_REDIRECT_URL=${MINIO_BROWSER_URL:-http://localhost:9001}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    networks:
      - ufo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============ OneAPI 统一网关 (可选) ============
  oneapi:
    image: justsong/one-api:latest
    container_name: oneapi
    ports:
      - "3000:3000"
    environment:
      - SQL_DSN=${ONEAPI_SQL_DSN:-}
      - REDIS_CONN_STRING=${ONEAPI_REDIS:-}
      - SESSION_SECRET=${ONEAPI_SESSION_SECRET:-ufo-galaxy-secret}
      - TZ=Asia/Shanghai
    volumes:
      - oneapi-data:/data
    networks:
      - ufo-network
    restart: unless-stopped
    profiles:
      - full

  # ============ Ollama 本地模型 ============
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - ufo-network
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ============ MemOS 记忆系统 (可选) ============
  memos:
    image: memtensor/memos:latest
    container_name: memos
    ports:
      - "8080:8080"
    environment:
      - REDIS_URL=redis://redis:6379
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=${NEO4J_USER:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-neo4j123}
      - QDRANT_URL=http://qdrant:6333
    volumes:
      - memos-data:/data
    depends_on:
      - redis
      - neo4j
      - qdrant
    networks:
      - ufo-network
    restart: unless-stopped
    profiles:
      - full

  # ============ Redis (达工用配置合合配置) ============
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - ufo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # ============ MongoDB (组件存储) ============
  mongodb:
    image: mongo:7
    container_name: mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGODB_USER:-mongoadmin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD:-mongoadmin123}
      - MONGO_INITDB_DATABASE=${MONGODB_DB:-ufo-galaxy}
    volumes:
      - mongo-data:/data/db
    networks:
      - ufo-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============ AgentCPM-GUI 服务失败 语义个人推 ============
  agentcpm:
    build:
      context: .
      dockerfile: Dockerfile.agentcpm
    container_name: agentcpm
    ports:
      - "8001:8001"
    environment:
      - MODEL_PATH=/models/AgentCPM-GVI
    volumes:
      - agentcpm-models:/models
    networks:
      - ufo-network
    restart: unless-stopped
    profiles:
      - full
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

networks:
  ufo-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  # Neo4j 数据号
  neo4j-data:
  neo4j-logs:
  neo4j-import:
  neo4j-plugins:
  
  # Qdrant 数据号
  qdrant-storage:
  qdrant-snapshots:
  
  # MinIO 数据号
  minio-data:
  
  # MongoDB 数据号
  mongo-data:
  
  # 原背数据号
  oneapi-data:
  ollama-models:
  memos-data:
  redis-data:
  agentcpm-models:
